<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Lucky Wheel Live</title>
  <style>
    body {
      background: #0d0d0d;
      font-family: 'Poppins', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      margin: 0;
      padding: 0;
      color: #fff;
    }

    #luckyCube {
      width: 140px;
      height: 140px;
      margin-top: 100px;
      background: linear-gradient(135deg, #00f0ff, #ff00f0);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 42px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 25px #00f0ff, 0 0 50px #ff00f0 inset;
      animation: cubePulse 1s infinite alternate;
    }

    @keyframes cubePulse {
      0% { transform: rotateX(0deg) rotateY(0deg) scale(1); }
      50% { transform: rotateX(10deg) rotateY(15deg) scale(1.2); }
      100% { transform: rotateX(0deg) rotateY(0deg) scale(1); }
    }

    #casesContainer {
      display: flex;
      overflow: hidden;
      width: 400px;
      height: 70px;
      margin-top: 50px;
      display: none;
      border-radius: 15px;
      background: #111;
      box-shadow: 0 0 20px #00f0ff inset;
      position: relative;
    }

    .case {
      flex: 0 0 120px;
      height: 70px;
      margin: 0 5px;
      background: linear-gradient(135deg, #ff6a00, #ffd800);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 20px;
      border-radius: 10px;
      color: #111;
      box-shadow: 0 0 12px #fff inset;
    }

    #result {
      margin-top: 40px;
      font-size: 32px;
      font-weight: bold;
      color: #00ffb0;
      text-shadow: 0 0 5px #00ffb0, 0 0 15px #00ffb0, 0 0 25px #00ffb0;
      opacity: 1;
      transform: scale(1);
      transition: opacity 0.6s ease, transform 0.6s ease;
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #fff;
      opacity: 1;
      top: 0;
      animation: fall 2s linear forwards;
    }

    @keyframes fall {
      0% { transform: translateY(0) rotate(0deg); opacity:1;}
      100% { transform: translateY(500px) rotate(360deg); opacity:1;}
    }

    .case img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
    }
  </style>
</head>
<body>

  <div id="luckyCube">ðŸŽ²</div>
  <div id="casesContainer"></div>
  <div id="result"></div>

  <script>
    const luckyCube = document.getElementById("luckyCube");
    const casesContainer = document.getElementById("casesContainer");
    const resultDiv = document.getElementById("result");

    let pointsReceived = 0;

    // RÃ©sultats pondÃ©rÃ©s
    const weightedResults = [
      { type: "image", src: "https://raw.githubusercontent.com/Atelier-menuiserie01/luckywheel/main/67.png", weight: 2 },
      { type: "text", text: "ðŸŽ€ Rose", weight: 0.5 },
      { type: "text", text: "ðŸ¤Ÿ Finger Heart", weight: 1.5 },
      { type: "text", text: "ðŸŒŒ Galaxie", weight: 7.5 }
    ];

    function getRandomResult() {
      const totalWeight = weightedResults.reduce((sum, r) => sum + r.weight, 0);
      let rand = Math.random() * totalWeight;
      for (let r of weightedResults) {
        if (rand < r.weight) return r;
        rand -= r.weight;
      }
    }

    function spawnConfetti() {
      for (let i=0; i<25; i++){
        const conf = document.createElement("div");
        conf.className = "confetti";
        conf.style.left = Math.random()*window.innerWidth+"px";
        conf.style.background = `hsl(${Math.random()*360},100%,70%)`;
        document.body.appendChild(conf);
        setTimeout(()=>conf.remove(),2000);
      }
    }

    function generateCases() {
      casesContainer.innerHTML = "";
      const repeat = 5;
      for(let r=0; r<repeat; r++){
        weightedResults.forEach(res => {
          const div = document.createElement("div");
          div.className = "case";

          if(res.type === "image") {
            const img = document.createElement("img");
            img.src = res.src;
            div.appendChild(img);
          } else {
            div.textContent = res.text;
          }

          casesContainer.appendChild(div);
        });
      }
    }

    // WebSocket pour recevoir les points cadeaux
    const socket = new WebSocket("ws://localhost:8080"); // serveur WebSocket
    socket.addEventListener("message", event => {
      const data = JSON.parse(event.data);
      if(data.type === "gift") {
        pointsReceived += data.points;
        console.log("Points reÃ§us :", pointsReceived);
        // mise Ã  jour de la pondÃ©ration
        weightedResults.forEach(r => {
          if(r.type === "image") r.weight = 2 + pointsReceived * 0.1;
        });
      }
    });

    function lancerLuckyWheel() {
      luckyCube.style.display = "block";
      casesContainer.style.display = "none";
      resultDiv.style.opacity = 0;
      resultDiv.style.transform = "scale(0.5)";
      resultDiv.textContent = "";

      setTimeout(() => {
        luckyCube.style.display = "none";
        casesContainer.style.display = "flex";
        generateCases();

        let duration = 2000;
        let start = null;
        let container = casesContainer;
        let startScroll = 0;
        let endScroll = container.scrollWidth / 5;

        const finalResult = getRandomResult();

        const allCases = container.querySelectorAll(".case");
        let indexFinal = Array.from(allCases).findIndex(c => {
          if(finalResult.type === "image") return c.querySelector("img")?.src === finalResult.src;
          return c.textContent === finalResult.text;
        });

        endScroll += indexFinal * 130;

        function animate(timestamp){
          if(!start) start = timestamp;
          let progress = timestamp - start;
          let t = Math.min(progress/duration, 1);
          t = t*(2-t);
          container.scrollLeft = startScroll + (endScroll - startScroll)*t;

          if(progress < duration){
            requestAnimationFrame(animate);
          } else {
            resultDiv.textContent = finalResult.type === "image" ? "ðŸŽ‰ Image !" : "ðŸŽ‰ " + finalResult.text;
            resultDiv.style.opacity = 1;
            resultDiv.style.transform = "scale(1)";
            spawnConfetti();

            setTimeout(()=> lancerLuckyWheel(), 4000);
          }
        }

        requestAnimationFrame(animate);
      }, 2000);
    }

    luckyCube.addEventListener("click", lancerLuckyWheel);
  </script>

</body>
</html>
